<!-- Inspired from: https://chodounsky.net/2015/05/14/full-text-search-on-static-website/ -->
<form action="{{ "/search" | absLangURL }}" id="search-form" class="search" method="GET" >
  <input name="q" type="text" id="search-input" />
  <input type="submit" value="Search" />
</form>

<section>
  <ul id="search-results"></ul>
</section>

<script type="text/javascript" charset="utf-8">
var input = document.getElementById("search-input");
var form = document.getElementById("search-form");
var resultsContainer = document.getElementById("search-results");

function loadJSON(path, success, error) {
  var xhr = new XMLHttpRequest();
  xhr.overrideMimeType("application/json");
  xhr.onreadystatechange = function() {
    if (xhr.readyState === XMLHttpRequest.DONE) {
      if (xhr.status === 200) {
        if (success)
          success(JSON.parse(xhr.responseText));
      } else {
        if (error)
          error(xhr);
      }
    }
  };
  xhr.open("GET", path, true);
  xhr.send(null);
}

loadJSON({{ "/index.json" | absLangURL }},
  function(index) {
    var pagesIndex = index;
    var lunrIndex = lunr(function() {
      {{- if not (eq .Site.Language.Lang "en") }}
        alert({{ .Site.Language.Lang }});
        this.use(lunr.fr);
      {{ end -}}
      this.field("title");
      this.field("content");
      // ref is the result item identifier (I chose the page URL)
      this.ref("url");
      // Feed lunr with each file and let lunr actually index them
      pagesIndex.forEach(function(page) {
        this.add(page);
      }, this);
    });

    var clearResults = function() {
      resultsContainer.innerHTML = "";
    };

    var renderResults = function(results) {
      results.forEach(function(result) {
        var li = document.createElement("li");
        var a = document.createElement("a");
        a.href = result.url;
        a.innerHTML = result.title;
        li.appendChild(a);
        resultsContainer.appendChild(li);
      });
    };

    var search = function(query) {
      clearResults();
      results = lunrIndex.search(query).map(function(result) {
        return pagesIndex.filter(function(page) {
          return page.url === result.ref;
        })[0];
      });
      // console.log(results);
      renderResults(results);
    };

    form.addEventListener("submit", function(e) {
      e.preventDefault();
      search('*' + input.value + '*');
    });

  },
  function(xhr) { console.error(xhr); }
);

</script>
